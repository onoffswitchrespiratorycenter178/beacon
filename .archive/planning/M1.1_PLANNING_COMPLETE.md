# M1.1 Architectural Hardening - Planning Phase Complete

**Date**: 2025-11-01
**Status**: âœ… Planning Complete, Ready for Implementation
**Milestone**: M1.1 - Architectural Hardening
**Duration**: Planning phase completed in single session

---

## Executive Summary

M1.1 Architectural Hardening planning phase is **COMPLETE**. All specifications, governance updates, and implementation planning have been finalized. The milestone is ready to proceed to implementation.

**Key Achievements**:
1. âœ… Constitution amended (v1.0.0 â†’ v1.1.0) - Added Principle V: Dependencies and Supply Chain
2. âœ… Roadmap v2.0 published - M1 through M6 detailed plans with M1.1 as critical path
3. âœ… Three new F-series architecture specifications created (F-9, F-10, F-11)
4. âœ… Architectural pitfalls analyzed with long-term RFC compliance lens
5. âœ… Dependencies justified per constitutional requirements

**Critical Insight**: M1.1 is not "nice to have" - it's **BLOCKING for M2-M6**. Building a responder (M2) on faulty socket configuration creates unfixable technical debt.

---

## Deliverables

### 1. Constitution Amendment v1.1.0

**File**: `.specify/memory/constitution.md`
**Change**: v1.0.0 â†’ v1.1.0 (MINOR version bump)

**NEW Principle V: Dependencies and Supply Chain**

Establishes clear policy for dependency management:

**Standard Library (PREFERRED)**:
- Use stdlib for all functionality when possible
- No justification required

**Semi-Standard Libraries (ALLOWED WITH JUSTIFICATION)**:
- `golang.org/x/sys/*`: Platform-specific syscalls (SO_REUSEPORT, socket options)
- `golang.org/x/net/*`: Advanced networking (multicast group management)
- Must meet ALL criteria:
  1. Required for platform-specific operations (syscalls, low-level networking)
  2. No standard library alternative exists
  3. Maintained by Go team under `golang.org/x/*`
  4. Justification documented in architecture specifications

**Third-Party Libraries (PROHIBITED WITHOUT AMENDMENT)**:
- External libraries require constitutional amendment
- Must demonstrate critical need with security audit

**Justification Examples Provided**:
- `golang.org/x/sys/unix`: Required for SO_REUSEPORT (Avahi/Bonjour coexistence) - no stdlib alternative
- `golang.org/x/net/ipv4`: Required for multicast group management (RFC 6762 Â§5) - no stdlib alternative
- Go Issues #73484, #34728: Standard library bugs make `net.ListenMulticastUDP()` unsuitable

**Rationale**: Platform-specific networking operations (socket options, multicast) require system calls unavailable in standard library. Go team maintains semi-standard libraries specifically for this purpose, balancing supply chain risk with necessary functionality.

---

### 2. Roadmap v2.0

**File**: `ROADMAP.md`
**Change**: Complete overhaul from Phase 0 structure to milestone-based roadmap

**Milestone Structure**:

```
Phase 0 (Foundation) âœ… COMPLETE
    â†“
M1 (Basic Querier) âœ… COMPLETE (107/107 tasks, 85.9% coverage)
    â†“
M1.1 (Architectural Hardening) ðŸ”„ PLANNING COMPLETE
    â†“
M2 (Responder) â†’ BLOCKED until M1.1 complete
    â†“
M3 (DNS-SD) â†’ depends on M2
    â†“
M4 (Advanced Features) â†’ depends on M3
    â†“
M5 (Platform Expansion) â†’ depends on M4
    â†“
M6 (Enterprise Ready) â†’ depends on M5
    â†“
v1.0.0 Release ðŸŽ‰
```

**M1.1 Critical Deliverables** (detailed in roadmap):

1. **Socket Configuration Overhaul** ðŸ”´ CRITICAL (~6 hours)
   - Replace `net.ListenMulticastUDP()` with `ListenConfig` pattern
   - Platform-specific socket options (SO_REUSEADDR, SO_REUSEPORT)
   - Coexistence with Avahi/systemd-resolved/Bonjour

2. **Interface Management API** ðŸ”´ CRITICAL (~5 hours)
   - `WithInterfaces()`, `WithInterfaceFilter()` functional options
   - `DefaultInterfaces()` with VPN/Docker exclusion
   - Privacy-preserving by default (no VPN leakage)

3. **Security Hardening** ðŸŸ¡ HIGH (~3.5 hours)
   - Source IP filtering (link-local validation per RFC 6762 Â§2)
   - Rate limiting (multicast storm protection, 100 queries/sec threshold)

4. **Architecture Specifications** (~6 hours)
   - F-9: Transport Layer & Socket Configuration
   - F-10: Network Interface Management
   - F-11: Security Architecture

**Total Effort**: ~25 hours (2-3 weeks part-time)

**Success Criteria**:
- SC-M1.1-001: Coexists with Avahi/systemd-resolved (no port conflicts)
- SC-M1.1-002: VPN/Docker exclusion by default (privacy preserved)
- SC-M1.1-003: Source IP filtering enforces link-local scope (RFC compliant)
- SC-M1.1-004: Rate limiting survives 1000+ queries/sec attack (no crash)
- SC-M1.1-005-007: Zero regression, platform tests pass, â‰¥80% coverage

**Timeline Estimates**:
- **Aggressive** (full-time): ~10-11 weeks to v1.0.0
- **Realistic** (part-time, 20hrs/week): ~20-22 weeks to v1.0.0 (~5-6 months)
- **Target**: v1.0.0 by Q2 2025

---

### 3. F-9: Transport Layer & Socket Configuration

**File**: `.specify/specs/F-9-transport-layer-socket-configuration.md`
**Type**: Architecture Specification
**Version**: 1.0.0
**Status**: Draft (ready for implementation)

**Purpose**: Defines Beacon's transport layer for multicast DNS socket configuration, addressing Go stdlib bugs and enabling Avahi/Bonjour coexistence.

**Key Requirements**:

**REQ-F9-1: ListenConfig Pattern (MANDATORY)**
- Use `net.ListenConfig` with `Control` function to set socket options BEFORE bind()
- Forbidden: `net.ListenMulticastUDP()`, `net.ListenPacket()` with multicast address
- Rationale: Go Issues #73484, #34728 make stdlib functions unsuitable

**REQ-F9-2: Platform-Specific Socket Options (MANDATORY)**
- **Linux (kernel >= 3.9)**: SO_REUSEADDR + SO_REUSEPORT (via golang.org/x/sys/unix)
- **macOS**: SO_REUSEADDR + SO_REUSEPORT (via golang.org/x/sys/unix)
- **Windows**: SO_REUSEADDR only (SO_REUSEPORT not supported)
- **Linux (kernel < 3.9)**: SO_REUSEADDR only (coexistence not guaranteed)

**REQ-F9-3: Multicast Group Membership (MANDATORY - RFC Compliant)**
- Join multicast group 224.0.0.251 per RFC 6762 Â§5
- Use `golang.org/x/net/ipv4.PacketConn.JoinGroup()`
- Set multicast TTL 255 per RFC 6762 Â§11
- Enable multicast loopback per RFC 6762 Â§15.1

**REQ-F9-4: Dependency Justification (CONSTITUTIONAL REQUIREMENT)**
- **golang.org/x/sys/unix**: Justified for SO_REUSEPORT (no stdlib alternative)
- **golang.org/x/net/ipv4**: Justified for multicast group management (no stdlib alternative)
- Both are Go team maintained semi-standard libraries

**REQ-F9-5: Error Handling for Port Conflicts (MANDATORY)**
- Handle "address already in use" gracefully
- Provide actionable error messages with remediation steps

**REQ-F9-6: Socket Buffer Configuration (MANDATORY)**
- Receive buffer: 64KB minimum
- Send buffer: 64KB minimum
- Rationale: Multicast burst traffic, RFC 6762 Â§6 allows 9000-byte messages

**Implementation Files**:
```
internal/network/
â”œâ”€â”€ socket.go              # Common interface and ListenConfig logic
â”œâ”€â”€ socket_linux.go        # Linux-specific (SO_REUSEADDR + SO_REUSEPORT)
â”œâ”€â”€ socket_darwin.go       # macOS-specific (SO_REUSEADDR + SO_REUSEPORT)
â”œâ”€â”€ socket_windows.go      # Windows-specific (SO_REUSEADDR only)
â”œâ”€â”€ multicast.go           # Multicast group management (golang.org/x/net/ipv4)
â””â”€â”€ socket_test.go         # Platform-agnostic tests
```

**Testing Strategy**:
- Unit tests: Platform-specific socket option verification
- Integration tests: Avahi coexistence (Linux), Bonjour coexistence (macOS)
- Manual testing: Verify both Beacon and system daemon can bind to port 5353

---

### 4. F-10: Network Interface Management

**File**: `.specify/specs/F-10-network-interface-management.md`
**Type**: Architecture Specification
**Version**: 1.0.0
**Status**: Draft (ready for implementation)

**Purpose**: Defines explicit network interface management to prevent VPN leakage, Docker confusion, and RFC 6762 Â§2 link-local scope violations.

**Key Requirements**:

**REQ-F10-1: Explicit Interface API (MANDATORY - RFC Compliant)**
- `WithInterfaces([]net.Interface)` - Explicit interface selection
- `WithInterfaceFilter(func(net.Interface) bool)` - Custom filtering
- `DefaultInterfaces() ([]net.Interface, error)` - Intelligent defaults

**REQ-F10-2: Default Interface Filtering Logic (MANDATORY - Privacy & Security)**
- Include: Up, Multicast-capable, physical interfaces
- Exclude:
  - Loopback (unless explicitly requested)
  - VPN interfaces: utun*, ppp*, tun*, tap*
  - Container networks: docker0, veth*, br-*
  - Virtual tunnels: gre*, ipip*, sit*

**REQ-F10-3: Interface Validation (MANDATORY)**
- Check: Exists, Up, Multicast-capable, Has IPv4 address, MTU >= 512 bytes

**REQ-F10-4: Logging and Visibility (MANDATORY)**
- Debug: Each interface evaluated and filter decision
- Info: Selected interfaces on startup
- Warn: No valid interfaces, suspicious config

**REQ-F10-5: Future Network Change Detection (ARCHITECTURAL)**
- Architecture supports future network change monitoring
- M1.1: Manual restart via `Close()` + `New()`
- M1.2/M4: Automatic detection via platform-specific APIs (netlink, kqueue, RegisterInterfaceChange)

**REQ-F10-6: Platform-Specific Interface Patterns (MANDATORY)**
- Linux: `tun*`, `tap*`, `ppp*`, `docker0`, `veth*`, `br-*`, `eth*`, `wlan*`
- macOS: `utun*`, `ppp*`, `bridge*`, `en*`
- Windows: Rely on interface flags and type checking (name patterns unreliable)

**Privacy Impact**:
- **Prevents VPN leakage**: Queries don't leak to VPN provider
- **Prevents Docker confusion**: Queries don't enter container networks
- **RFC 6762 Â§2 compliance**: VPN/virtual interfaces are NOT link-local

**Testing Strategy**:
- Unit tests: Interface filtering logic (VPN, Docker patterns)
- Integration tests: Real network interface enumeration
- Manual tests: VPN leakage verification (tcpdump on VPN interface)

---

### 5. F-11: Security Architecture

**File**: `.specify/specs/F-11-security-architecture.md`
**Type**: Architecture Specification
**Version**: 1.0.0
**Status**: Draft (ready for implementation)

**Purpose**: Defines defense-in-depth security controls for protecting against attacks, malicious packets, and resource exhaustion.

**Key Requirements**:

**REQ-F11-1: Source IP Filtering (MANDATORY - RFC Compliant)**
- Validate source IP is link-local (169.254.0.0/16) or same subnet as receiving interface
- Silent drop of non-link-local packets BEFORE parsing
- RFC 6762 Â§2 enforcement: "Multicast DNS is restricted to link-local scope"

**REQ-F11-2: Rate Limiting (MANDATORY - Resilience)**
- Per-source-IP rate limiting: >100 queries/second â†’ cooldown
- Cooldown: Drop packets from source for 60 seconds
- Configurable threshold and cooldown duration
- Real-world defense: Hubitat bug (2020) sent 1000 queries/sec, crashed ESP32 devices

**REQ-F11-3: Input Validation (MANDATORY - Already Implemented in M1)**
- âœ… Status: ALREADY IMPLEMENTED
- Evidence: T094 FuzzParseMessage (100+ executions, zero crashes)
- No action required for M1.1

**REQ-F11-4: Fuzzing (MANDATORY - Already Implemented in M1)**
- âœ… Status: ALREADY IMPLEMENTED
- Evidence: FuzzParseMessage test exists
- M1.1 adds: CI integration (30-second fuzz run)

**REQ-F11-5: Packet Size Limits (MANDATORY)**
- Reject packets >9000 bytes (RFC 6762 Â§17 maximum)
- Prevents memory allocation DoS

**REQ-F11-6: Resource Limits (MANDATORY)**
- Bounded receive buffer: 64KB (F-9)
- Bounded packet processing: Rate limiting (REQ-F11-2)
- Bounded goroutine creation: Worker pool (deferred to M4)
- Timeout for all operations: context.Context (F-4)

**Implementation**:
```go
// RateLimiter tracks per-source-IP query rates
type RateLimiter struct {
    queries   map[string]*queryTracker // IP -> tracker
    threshold int                      // Queries per second (default: 100)
    cooldown  time.Duration            // Cooldown period (default: 60s)
}

// Integrated into receive loop (F-9)
func (s *Socket) Receive(ctx context.Context) ([]byte, net.Addr, error) {
    // 1. Source IP filtering (REQ-F11-1)
    if !isLinkLocalSource(srcIP, iface) {
        continue // Silent drop
    }

    // 2. Rate limiting (REQ-F11-2)
    if rateLimiter.IsRateLimited(srcIP) {
        continue // Silent drop
    }

    // 3. Packet size validation (REQ-F11-5)
    if n > 9000 {
        continue // Drop oversized
    }

    // Passed all security checks
    return buf[:n], srcAddr, nil
}
```

**Testing Strategy**:
- Unit tests: Rate limiting logic, source IP validation
- Integration tests: Attack simulation (multicast storm, spoofed IPs)
- Fuzz tests: Malformed packet handling (already done in M1)
- Performance tests: Security check overhead (<1% CPU)

---

## Architectural Analysis Summary

### Problem: Short-Term vs Long-Term Thinking

**Initial Analysis** (FLAWED):
- "Query-only doesn't need SO_REUSEPORT" (wrong: Avahi binds to 5353)
- "DRDoS doesn't apply to query-only" (right, but misses the point)
- "VPN leakage is minor for query-only" (wrong: privacy violation)
- "Defer to M2" (wrong: creates unfixable technical debt)

**Corrected Analysis** (with long-term lens):
- Architecture is not incremental - can't bolt on correctness later
- Production-ready means works in enterprise (Avahi/systemd-resolved running)
- Privacy violations are ALWAYS wrong (RFC 6762 Â§2 link-local scope)
- M2 rewrite costs weeks + breaking changes + user trust loss
- Foundation must be solid BEFORE building on top

### Critical Reframing

**"Production-Ready" Actually Means**:
1. âœ… Works in enterprise environments (Avahi/systemd-resolved running)
2. âœ… Secure by design (not just "doesn't amplify attacks")
3. âœ… Privacy-respecting (doesn't leak queries to VPN)
4. âœ… Resilient (doesn't crash under attack/malfunction)
5. âœ… Architecturally sound (foundation for future RFCs)

**None of these are "query-only" concerns. They're basic engineering hygiene.**

---

## Constitution Dilemma - Resolved

**Original Interpretation**:
- "Standard library only" means NO external dependencies

**Correct Interpretation**:
- Standard library: High-level, cross-platform abstractions
- `golang.org/x/*`: Semi-standard, Go team maintained, platform-specific necessities
- External third-party: Supply chain risk, requires justification

**Why golang.org/x/* is Semi-Standard**:
- Maintained by Go team (same trust level as stdlib)
- Used by: Kubernetes, Docker, HashiCorp, EVERY serious Go network tool
- Required for: Platform syscalls, socket options, multicast operations
- No alternative exists: stdlib has UNFIXABLE bugs (#73484, #34728)

**Constitutional Amendment Justification**:
- Platform syscalls CANNOT be abstracted in pure stdlib
- RFC 6762 compliance REQUIRES platform-specific socket options
- Go team provides `golang.org/x/*` specifically for this purpose
- Balance: Minimize third-party deps while enabling necessary functionality

---

## Implementation Priority Matrix

### ðŸ”´ CRITICAL - Must Implement for M1.1 (Architectural Foundation)

**1. Socket Configuration (F-9)** - ~6 hours
- ListenConfig + SO_REUSEPORT
- Platform-specific socket option files
- Multicast group membership
- **Why CRITICAL**: Avahi coexistence non-negotiable, socket rewrite in M2 = breaking changes

**2. Interface Management (F-10)** - ~5 hours
- WithInterfaces() API
- DefaultInterfaces() with VPN/Docker exclusion
- Interface validation
- **Why CRITICAL**: VPN leakage is privacy violation, affects M1 users TODAY

**3. Source IP Filtering (F-11)** - ~30 minutes
- Link-local validation in receive loop
- **Why CRITICAL**: RFC 6762 Â§2 compliance, trivial cost (~5 nanoseconds per packet)

**4. Rate Limiting (F-11)** - ~3 hours
- Per-source-IP tracking with cooldown
- **Why CRITICAL**: Real-world resilience (Hubitat bug proof), simple implementation

### âœ… ALREADY DONE (From M1)

**5. Input Validation (F-11)** - M1 already compliant
- Malformed packet handling
- WireFormatError type
- Bounds checking

**6. Fuzzing (F-11)** - M1 already compliant
- FuzzParseMessage implemented
- 100+ executions, zero crashes
- M1.1 adds: CI integration

---

## Next Steps

### Immediate (Next Session)

**Option A: Proceed with M1.1 Implementation**
1. Update go.mod to add `golang.org/x/sys` and `golang.org/x/net`
2. Implement socket.go with ListenConfig pattern
3. Create platform-specific socket option files (Linux, macOS, Windows)
4. Implement DefaultInterfaces() with VPN/Docker filtering
5. Add source IP filtering to receive loop
6. Implement RateLimiter
7. Write tests for new functionality
8. Validate Avahi coexistence (integration test)

**Option B: Create M1.1 Specification and Tasks**
1. Create `/specs/003-m1.1-architectural-hardening/spec.md`
2. Create `/specs/003-m1.1-architectural-hardening/tasks.md` (following TDD approach)
3. Create `/specs/003-m1.1-architectural-hardening/plan.md`
4. Follow Spec Kit methodology for formal planning

**Recommendation**: **Option B** - Follow spec-driven development (Constitution Principle II)

### Medium-Term (M1.1 Completion)

1. Complete all M1.1 tasks (~25 hours, 2-3 weeks)
2. Update completion summary (similar to M1)
3. Tag M1.1 release
4. Update README with new capabilities
5. Begin M2 (mDNS Responder) planning

### Long-Term (v1.0.0)

- M2-M6 implementation following updated roadmap
- v1.0.0 release: Q2 2025 (realistic estimate)

---

## Risk Assessment

### Risks Mitigated

âœ… **R1: Technical Debt Accumulation**
- **Risk**: Building M2 on faulty M1 socket layer
- **Mitigation**: M1.1 fixes architectural foundation BEFORE M2
- **Status**: MITIGATED (M1.1 planning complete)

âœ… **R2: Enterprise Adoption Blocker**
- **Risk**: Cannot run on systems with Avahi/systemd-resolved
- **Mitigation**: SO_REUSEPORT enables coexistence (F-9)
- **Status**: WILL BE MITIGATED (M1.1 implementation)

âœ… **R3: Privacy Violations**
- **Risk**: mDNS queries leak to VPN provider
- **Mitigation**: VPN interface exclusion by default (F-10)
- **Status**: WILL BE MITIGATED (M1.1 implementation)

âœ… **R4: RFC Compliance Violation**
- **Risk**: VPN/virtual interface traffic violates RFC 6762 Â§2 link-local scope
- **Mitigation**: Interface filtering + source IP validation (F-10 + F-11)
- **Status**: WILL BE MITIGATED (M1.1 implementation)

### Remaining Risks

âš ï¸ **R5: Platform Compatibility** (LOW)
- **Risk**: Platform-specific code may have bugs on untested platforms
- **Mitigation**: Comprehensive platform testing (Linux, macOS, Windows)
- **Action**: CI/CD for all platforms

âš ï¸ **R6: Dependency Risk** (VERY LOW)
- **Risk**: golang.org/x/* dependencies introduce supply chain risk
- **Mitigation**: Go team maintained, widely used, no third-party deps
- **Assessment**: Acceptable risk given necessity and trust level

---

## Quality Metrics

### Specification Quality

- âœ… Constitution amended with full rationale
- âœ… Roadmap provides clear milestone path (M1-M6)
- âœ… Three F-series specs with RFC validation sections
- âœ… Dependency justifications per Constitution v1.1.0
- âœ… Cross-references between specs (F-9 â†” F-10 â†” F-11)
- âœ… Testing strategies defined for each requirement
- âœ… Success criteria measurable and testable

### Architectural Integrity

- âœ… Addresses all critical pitfalls from research
- âœ… RFC compliance validated against RFC 6762 Â§2, Â§5, Â§6, Â§11, Â§17, Â§18
- âœ… Constitutional compliance verified (Principles I, V, VIII)
- âœ… Platform-specific requirements documented
- âœ… Security threat model defined with mitigations

### Documentation Quality

- âœ… 4 major documents updated/created:
  1. Constitution v1.1.0
  2. ROADMAP.md v2.0
  3. F-9 specification (6,800+ words)
  4. F-10 specification (5,400+ words)
  5. F-11 specification (6,200+ words)
- âœ… Total documentation: ~25,000 words
- âœ… All cross-references validated
- âœ… Code examples provided for complex patterns
- âœ… Platform-specific guidance (Linux, macOS, Windows)

---

## Conclusion

M1.1 Architectural Hardening planning phase is **COMPLETE** and **READY FOR IMPLEMENTATION**.

**Key Achievement**: Transformed short-term "minimum viable" thinking into long-term architectural integrity. M1.1 is not "polish" - it's **foundational correctness** that makes M2-M6 possible.

**Constitutional Alignment**: All work validates against Constitution v1.1.0:
- âœ… Principle I: RFC Compliance (6762 Â§2, Â§5, Â§6, Â§11, Â§17, Â§18)
- âœ… Principle II: Spec-Driven Development (F-9, F-10, F-11 complete)
- âœ… Principle V: Dependencies (golang.org/x/* justified)
- âœ… Principle VIII: Excellence (addresses research pitfalls)

**Next Session**: Create M1.1 specification and tasks per Spec Kit methodology, then proceed to implementation.

**Estimated Completion**: M1.1 implementation in 2-3 weeks (part-time), v1.0.0 by Q2 2025.

---

**Planning Phase Duration**: Single session (2025-11-01)
**Planning Artifacts**: 5 documents, ~25,000 words, complete architectural foundation
**Implementation Estimate**: ~25 hours (socket config, interface mgmt, security hardening, testing)

ðŸŽ‰ **M1.1 PLANNING COMPLETE - READY TO BUILD** ðŸŽ‰
