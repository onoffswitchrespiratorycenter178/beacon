#!/bin/bash
#
# Pre-commit hook for Semgrep static analysis
#
# Installation:
#   chmod +x .githooks/pre-commit
#   ln -sf ../../.githooks/pre-commit .git/hooks/pre-commit
#
# Or configure git to use .githooks directory:
#   git config core.hooksPath .githooks
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo ""
echo "ğŸ” Running Semgrep static analysis..."
echo ""

# Check if semgrep is installed
if ! command -v semgrep &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  Warning: semgrep not found${NC}"
    echo "   Install with: pip install semgrep"
    echo "   Skipping Semgrep checks..."
    echo ""
    exit 0
fi

# Get list of staged Go files (exclude .semgrep-tests with intentional violations)
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' | grep -v '^\.semgrep-tests/' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "   No Go files staged for commit, skipping Semgrep..."
    echo ""
    exit 0
fi

# Run static analysis tools
echo "   Scanning $(echo "$STAGED_GO_FILES" | wc -l) Go file(s)..."
echo ""

# ==============================================================================
# 1. Run go vet (official Go static analyzer - fast!)
# ==============================================================================
echo "   [1/3] Running go vet..."
set +e
GO_VET_OUTPUT=$(go vet ./... 2>&1)
GO_VET_EXIT=$?
set -e

if [ $GO_VET_EXIT -ne 0 ]; then
    echo -e "${RED}âŒ go vet found issues${NC}"
    echo ""
    echo "$GO_VET_OUTPUT"
    echo ""
    exit 1
fi
echo -e "   ${GREEN}âœ“${NC} go vet passed"

# ==============================================================================
# 2. Run staticcheck (advanced static analysis)
# ==============================================================================
if command -v staticcheck &> /dev/null; then
    echo "   [2/3] Running staticcheck..."
    set +e
    # Filter out stub file warnings (M2 preparation code)
    STATICCHECK_OUTPUT=$(staticcheck ./... 2>&1 | grep -v "_stub.go" || true)
    STATICCHECK_EXIT=$?

    # Check if there are any real issues (non-stub files)
    if [ -n "$STATICCHECK_OUTPUT" ]; then
        STATICCHECK_EXIT=1
    else
        STATICCHECK_EXIT=0
    fi
    set -e

    if [ $STATICCHECK_EXIT -ne 0 ]; then
        echo -e "${RED}âŒ staticcheck found issues${NC}"
        echo ""
        echo "$STATICCHECK_OUTPUT"
        echo ""
        exit 1
    fi
    echo -e "   ${GREEN}âœ“${NC} staticcheck passed"
else
    echo -e "   ${YELLOW}âŠ˜${NC} staticcheck not installed (skipping)"
fi

# ==============================================================================
# 3. Run Semgrep (custom rules for F-Specs/Constitution)
# ==============================================================================
echo "   [3/3] Running Semgrep..."

# Create a temporary file to store findings
TEMP_OUTPUT=$(mktemp)
trap "rm -f $TEMP_OUTPUT" EXIT

# Run Semgrep (capture output and exit code)
# --error flag makes Semgrep exit with non-zero on findings
set +e
echo "$STAGED_GO_FILES" | xargs semgrep --config=.semgrep.yml --no-git-ignore --error > "$TEMP_OUTPUT" 2>&1
SEMGREP_EXIT_CODE=$?
set -e

# Check results
if [ $SEMGREP_EXIT_CODE -eq 0 ]; then
    echo -e "   ${GREEN}âœ“${NC} Semgrep passed"
    echo ""
    echo -e "${GREEN}âœ… All static analysis checks passed!${NC}"
    echo ""
    exit 0
else
    # Extract findings count from output
    FINDINGS=$(grep -oP '\d+(?= finding)' "$TEMP_OUTPUT" || echo "unknown")

    echo -e "${RED}âŒ Semgrep found $FINDINGS issue(s)${NC}"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    cat "$TEMP_OUTPUT"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ“‹ To fix these issues:"
    echo "   1. Review the findings above"
    echo "   2. Fix the code according to the recommendations"
    echo "   3. Run 'semgrep --config=.semgrep.yml .' to verify"
    echo ""
    echo "ğŸ”§ To suppress a false positive, add:"
    echo "   // nosemgrep: <rule-id>"
    echo "   With a comment explaining WHY it's suppressed"
    echo ""
    echo "â­ï¸  To skip this check (NOT recommended):"
    echo "   git commit --no-verify"
    echo ""

    # Exit with error to block commit
    exit 1
fi
